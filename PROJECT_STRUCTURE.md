# Структура проекта Journey Agent

## Обзор

Проект организован по модульному принципу с четким разделением ответственности между компонентами.

## Дерево директорий

```
Journey_agent/
├── src/                          # Исходный код приложения
│   ├── bot/                      # Telegram бот
│   │   ├── __init__.py
│   │   ├── bot.py                # Основной класс бота
│   │   ├── keyboards.py          # Клавиатуры для бота
│   │   └── handlers/             # Обработчики команд и сообщений
│   │       ├── __init__.py
│   │       ├── commands.py       # Команды (/start, /help, etc.)
│   │       ├── channels.py      # Обработка каналов
│   │       └── search.py         # Обработка поисковых запросов
│   │
│   ├── parsers/                  # Парсеры событий
│   │   ├── __init__.py
│   │   ├── base.py              # Базовый класс парсера
│   │   ├── telegram/            # Парсер Telegram каналов
│   │   │   ├── __init__.py
│   │   │   └── channel_parser.py
│   │   └── websites/            # Парсеры веб-сайтов
│   │       ├── __init__.py
│   │       ├── afisha.py        # Парсер Afisha.ru
│   │       ├── eventbrite.py    # Парсер Eventbrite
│   │       └── timepad.py       # Парсер Timepad
│   │
│   ├── services/                 # Бизнес-логика
│   │   ├── __init__.py
│   │   ├── vector_search.py     # Поиск в векторной БД
│   │   ├── geolocation.py       # Геолокация и расстояния
│   │   ├── event_processor.py   # Обработка событий
│   │   └── scheduler.py         # Планировщик задач
│   │
│   ├── storage/                  # Работа с данными
│   │   ├── __init__.py
│   │   ├── weaviate_client.py   # Клиент Weaviate
│   │   ├── user_storage.py      # Хранение пользователей
│   │   └── event_storage.py     # Хранение событий
│   │
│   ├── models/                   # Модели данных
│   │   ├── __init__.py
│   │   ├── event.py             # Модель события
│   │   ├── user.py              # Модель пользователя
│   │   ├── channel.py           # Модель канала
│   │   └── location.py          # Модель локации
│   │
│   ├── rag/                      # RAG система (legacy)
│   │   ├── __init__.py
│   │   ├── retriever.py
│   │   └── ...
│   │
│   ├── utils/                    # Утилиты
│   │   ├── __init__.py
│   │   ├── logging.py           # Настройка логирования
│   │   └── validators.py        # Валидаторы
│   │
│   └── config.py                 # Конфигурация
│
├── scripts/                      # Скрипты запуска
│   ├── add_events.py            # Добавление событий в БД
│   ├── run_bot.py               # Запуск бота
│   └── run_parser.py             # Запуск парсеров
│
├── examples/                     # Примеры использования
│   └── run_self_rag.py
│
├── data/                         # Данные (создается автоматически)
│   ├── users.json               # Пользователи
│   └── channels.json            # Каналы
│
├── docker-compose.yml           # Weaviate
├── requirements.txt             # Зависимости
├── .env.example                 # Пример переменных окружения
├── .gitignore
├── README.md                    # Основная документация
├── ARCHITECTURE.md              # Описание архитектуры
└── PROJECT_STRUCTURE.md         # Этот файл
```

## Описание компонентов

### Bot (`src/bot/`)

Telegram бот для взаимодействия с пользователями.

- **bot.py** - основной класс бота, инициализация и запуск
- **keyboards.py** - клавиатуры для удобного взаимодействия
- **handlers/** - обработчики различных типов сообщений:
  - `commands.py` - команды бота (/start, /help, etc.)
  - `channels.py` - добавление и управление каналами
  - `search.py` - обработка поисковых запросов

### Parsers (`src/parsers/`)

Парсеры для извлечения событий из различных источников.

- **base.py** - абстрактный класс для всех парсеров
- **telegram/** - парсер Telegram каналов
- **websites/** - парсеры веб-сайтов (Afisha, Eventbrite, Timepad)

Каждый парсер должен реализовать:
- `can_parse(url)` - проверка возможности парсинга
- `parse(...)` - извлечение событий

### Services (`src/services/`)

Бизнес-логика приложения.

- **vector_search.py** - семантический поиск в Weaviate
- **geolocation.py** - геокодирование адресов и расчет расстояний
- **event_processor.py** - нормализация и обработка событий
- **scheduler.py** - планировщик для периодического парсинга

### Storage (`src/storage/`)

Работа с данными.

- **weaviate_client.py** - клиент для векторной БД Weaviate
- **user_storage.py** - хранение данных пользователей (JSON файлы)
- **event_storage.py** - работа с событиями в БД

### Models (`src/models/`)

Модели данных на основе Pydantic.

- **event.py** - событие (название, описание, локация, дата, координаты)
- **user.py** - пользователь (ID, каналы, локация)
- **channel.py** - канал (ID, пользователь, статус)
- **location.py** - локация (адрес, координаты, город, страна)

## Поток данных

### Добавление событий

1. Пользователь добавляет канал через бота
2. Парсер периодически проверяет каналы
3. События извлекаются и обрабатываются
4. События векторизуются и сохраняются в Weaviate

### Поиск событий

1. Пользователь отправляет запрос боту
2. Бот извлекает локацию пользователя
3. Выполняется семантический поиск в Weaviate
4. Рассчитываются расстояния до событий
5. События сортируются и возвращаются пользователю

## Расширение проекта

### Добавление нового парсера

1. Создайте файл в `src/parsers/websites/`
2. Наследуйтесь от `BaseParser`
3. Реализуйте методы `can_parse()` и `parse()`
4. Зарегистрируйте в планировщике

### Добавление нового сервиса

1. Создайте файл в `src/services/`
2. Реализуйте необходимую логику
3. Импортируйте в нужных местах

### Изменение модели данных

1. Обновите соответствующую модель в `src/models/`
2. Обновите схему в Weaviate (если нужно)
3. Обновите обработчики, использующие модель

## Зависимости

Основные зависимости:
- `python-telegram-bot` - Telegram бот
- `weaviate-client` - векторная БД
- `geopy` - геолокация
- `beautifulsoup4` - парсинг HTML
- `APScheduler` - планировщик задач
- `pydantic` - валидация данных

Полный список см. в `requirements.txt`.


