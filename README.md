# 🗺️ Journey Agent — LLM-powered Weekend Planner

<p align="center">
  <strong>Персональный "weekend concierge" на базе LLM</strong>
</p>

Система собирает события из Telegram-каналов и агрегаторов, фильтрует их на основе предпочтений пользователя, строит оптимальный маршрут и формирует персонализированный план выходных.

---

## 📋 Содержание

- [О проекте](#-о-проекте)
- [Ключевые возможности](#-ключевые-возможности)
- [Архитектура системы](#-архитектура-системы)
- [Функционал интерфейса](#-функционал-интерфейса)
- [Быстрый старт](#-быстрый-старт)
- [Подробная инструкция по запуску](#-подробная-инструкция-по-запуску)
- [Переменные окружения](#-переменные-окружения)
- [API документация](#-api-документация)
- [Технический стек](#-технический-стек)
- [Структура проекта](#-структура-проекта)
- [Метрики качества](#-метрики-качества)

---

## 🎯 О проекте

**Journey Agent** — это интеллектуальная система планирования выходных, которая:

- Собирает данные о событиях из множества источников (KudaGo API, Telegram-каналы)
- Использует LLM для извлечения структурированной информации из неструктурированных данных
- Применяет Self-RAG для семантического поиска релевантных событий
- Строит оптимальные маршруты с учётом погоды, времени в пути и предпочтений пользователя
- Обеспечивает безопасность через многоуровневую модерацию контента

### Цели проекта

- 📈 Увеличение вовлечённости пользователей в офлайн-активности
- 💰 Создание базы для B2C монетизации (подписки, партнёрства)
- 🤖 Демонстрация LLM-агента, оркестрирующего реальный многошаговый workflow

---

## ✨ Ключевые возможности

| Возможность | Описание |
|-------------|----------|
| 🔍 **Умный поиск событий** | Семантический поиск с итеративной переформулировкой запросов (Self-RAG) |
| 📅 **Планирование маршрута** | Учёт времени, бюджета, транспорта и географии |
| 🌤️ **Интеграция с погодой** | Актуальная погода для планирования outdoor-активностей |
| 🗺️ **Маршрутизация** | Расчёт времени в пути (пешком, авто, общественный транспорт) |
| 🔒 **Безопасность** | Многоуровневая модерация входа/выхода |
| 📱 **Telegram бот** | Удобный интерфейс для взаимодействия |
| 🔄 **Автосинхронизация** | Периодический сбор событий из настроенных каналов |

---

## 🏗️ Архитектура системы

```
┌──────────────────────────────────────────────────────────────────────────┐
│                              DATA INGESTION                              │
└──────────────────────────────────────────────────────────────────────────┘

┌───────────────────────┐        ┌────────────────────────┐
│   KudaGo Parser       │        │    Telegram Parser     │
│  (events crawl/ETL)   │        │ (channels/posts ETL)   │
└───────────┬───────────┘        └───────────┬────────────┘
            │                                │
            └───────────────┬────────────────┘
                            ▼
                 ┌──────────────────────┐
                 │   Event Miner Agent  │
                 │ (LLM: extract/clean) │
                 └───────────┬──────────┘
                             ▼
                 ┌──────────────────────────┐
                 │   Events DB / Vector DB  │
                 │ (Weaviate + Contextionary)│
                 └──────────────────────────┘


┌──────────────────────────────────────────────────────────────────────────┐
│                               ONLINE SERVING                             │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                         Telegram Bot Interface                           │
└───────────────────────────────┬──────────────────────────────────────────┘
                                │  user query
                                ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                             Guardrails (I/O)                             │
│  - input validation / policy / toxicity filter                           │
└───────────────────────────────┬──────────────────────────────────────────┘
                                ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                         Retrieval: Self-RAG Agent                        │
│   ┌──────────────────────────────────────────────────────────────────┐   │
│   │ loop:                                                            │   │
│   │  1. retrieve(query) → events                                     │   │
│   │  2. analyze(relevance)                                           │   │
│   │  3. if NOT relevant → reformulate_query() → retry                │   │
│   │  4. else → extract_constraints → build InputData                 │   │
│   └──────────────────────────────────────────────────────────────────┘   │
└───────────────────────────────┬──────────────────────────────────────────┘
                                │  InputData (events + constraints)
                                ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                           Planning Graph                                 │
│   ┌───────────────────┐        ┌───────────────────────────────┐         │
│   │  Planner Agent    │ ─────▶ │   Critic Agent                │         │
│   │  (builds plan)    │ ◀───── │   (validates & critiques)     │         │
│   └─────────┬─────────┘        └───────────────────────────────┘         │
│   Tools: Weather / Maps / Web Search                                     │
└───────────────────────────────┬──────────────────────────────────────────┘
                                ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                       Guardrails (final output)                          │
│  - safety check / format validation                                      │
└───────────────────────────────┬──────────────────────────────────────────┘
                                ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                         Telegram Bot Response                            │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 📱 Функционал интерфейса

### Telegram Bot

Основной интерфейс для взаимодействия с системой. Бот предоставляет следующие возможности:

#### Главное меню

При запуске (`/start`) пользователь видит приветствие и две кнопки:

| Кнопка | Описание |
|--------|----------|
| 🗺️ **Создать маршрут** | Переход к созданию персонального плана выходных |
| ➕ **Добавить канал** | Добавление Telegram-канала для отслеживания событий |

#### Создание маршрута

1. **Ввод запроса** — пользователь описывает свои предпочтения:
   - *"Хочу провести выходные в центре Москвы, интересуюсь выставками и концертами"*
   - *"Планируй день с 10:00 до 20:00, бюджет 5000 рублей"*
   
2. **Обработка** — система:
   - Проверяет запрос на токсичность (Input Guardrails)
   - Ищет релевантные события в векторной БД
   - Извлекает ограничения (время, бюджет, транспорт)
   - Строит оптимальный план с учётом погоды и маршрутов
   
3. **Результат** — пользователь получает:
   - Структурированный план с временными слотами
   - Информацию о каждом событии (название, место, описание)
   - Рекомендации по маршруту между точками
   
4. **Уточнение** — можно добавить комментарий для корректировки плана:
   - *"Добавь больше кафе между мероприятиями"*
   - *"Хочу начать позже, с 12:00"*

#### Добавление каналов

Пользователь может добавить свои Telegram-каналы для персонального отслеживания событий:

- Полная ссылка: `https://t.me/channel_name`
- Username: `@channel_name`
- Просто имя: `channel_name`

После добавления система периодически синхронизирует каналы и извлекает события.

#### Модерация контента

Все входящие сообщения и исходящие ответы проходят через систему безопасности:

| Уровень | Действие |
|---------|----------|
| **Allow** | Контент безопасен, передаётся без изменений |
| **Soft** | Обнаружена грубость — контент санитизируется |
| **Block** | Токсичный контент — запрос отклоняется |

### REST API

API для управления синхронизацией каналов (доступен на порту 8000):

| Endpoint | Метод | Описание |
|----------|-------|----------|
| `/` | GET | Информация о сервисе |
| `/health` | GET | Проверка работоспособности |
| `/database` | GET | Статистика базы данных |
| `/channels` | GET | Список всех каналов |
| `/channels` | POST | Добавить новый канал |
| `/channels/user/{user_id}` | GET | Каналы пользователя |
| `/sync/trigger` | POST | Запустить синхронизацию вручную |
| `/sync/status` | GET | Статус синхронизации |

**Интерактивная документация**: http://localhost:8000/docs

---

## 🚀 Быстрый старт

### Требования

- Docker и Docker Compose
- API ключи (см. раздел [Переменные окружения](#-переменные-окружения))

### Запуск всей системы

```bash
# 1. Клонируйте репозиторий
git clone <repository-url>
cd Journey_agent

# 2. Создайте файл .env
cat > .env << EOF
TELEGRAM_APP_API_ID=your_telegram_api_id
TELEGRAM_APP_API_HASH=your_telegram_api_hash
TELEGRAM_BOT_TOKEN=your_bot_token
OPENAI_API_KEY=your_openai_key
OPENWEATHER_API_KEY=your_openweather_key
YANDEX_MAPS_API_KEY=your_yandex_maps_key
TAVILY_API_KEY=your_tavily_key
EOF

# 3. Запустите все сервисы
docker-compose up -d

# 4. Проверьте статус
docker-compose ps
```

### Проверка работоспособности

```bash
# Проверить API
curl http://localhost:8000/health

# Проверить Weaviate
curl http://localhost:8080/v1/.well-known/ready

# Посмотреть логи бота
docker-compose logs -f bot
```

---

## 📖 Подробная инструкция по запуску

### Вариант 1: Docker Compose (рекомендуется)

#### Запуск всех компонентов

```bash
docker-compose up -d
```

Это запустит:
- **Weaviate** — векторная БД (порт 8080)
- **Contextionary** — модуль векторизации
- **Sync Worker** — фоновая синхронизация каналов
- **API** — REST API для управления (порт 8000)
- **Bot** — Telegram бот

#### Запуск отдельных компонентов

```bash
# Только база данных
docker-compose up -d weaviate contextionary

# Только API
docker-compose up -d api

# Только бот
docker-compose up -d bot
```

#### Остановка

```bash
docker-compose down
```

### Вариант 2: Локальный запуск (для разработки)

#### 1. Установка зависимостей

```bash
python -m venv venv
source venv/bin/activate  # Linux/macOS
# или venv\Scripts\activate  # Windows

pip install -r requirements.txt
```

#### 2. Запуск Weaviate

```bash
docker-compose up -d weaviate contextionary
```

#### 3. Запуск компонентов

```bash
# Терминал 1: API
uvicorn src.sync_worker.api:app --reload --host 0.0.0.0 --port 8000

# Терминал 2: Sync Worker
python -m src.sync_worker.run_sync

# Терминал 3: Telegram Bot
python -m src.tgbot.bot
```

### Вариант 3: Использование main_pipeline напрямую

```python
from src.main_pipeline import main_pipeline

# Получить план выходных
result = main_pipeline(
    "Планируй выходные в Москве: выставки и концерты с 10:00 до 20:00"
)
print(result)
```

---

## 🔐 Переменные окружения

Создайте файл `.env` в корне проекта:

```env
# Telegram
TELEGRAM_APP_API_ID=your_api_id          # Для Telethon (парсинг каналов)
TELEGRAM_APP_API_HASH=your_api_hash      # Для Telethon
TELEGRAM_BOT_TOKEN=your_bot_token        # Для aiogram (бот)

# OpenAI
OPENAI_API_KEY=your_openai_key           # Для LLM (обязательно)
OPENAI_MODEL=gpt-4o-mini                 # Модель (опционально)

# Внешние сервисы (опционально)
OPENWEATHER_API_KEY=your_key             # Для погоды
YANDEX_MAPS_API_KEY=your_key             # Для геокодирования и маршрутов
TAVILY_API_KEY=your_key                  # Для веб-поиска

# Конфигурация Sync Worker
JOURNEY_AGENT_DB_PATH=data/channels_db/users_channels.db
CHANNEL_SYNC_INTERVAL_HOURS=6            # Интервал синхронизации
CHANNEL_MESSAGES_LIMIT=10                # Лимит сообщений на канал
WEAVIATE_URL=http://localhost:8080       # URL Weaviate
JOURNEY_AGENT_SEED_TEST_CHANNELS=true    # Добавить тестовые каналы
```

### Получение ключей

| Сервис | Как получить |
|--------|--------------|
| **Telegram API** | https://my.telegram.org/apps |
| **Telegram Bot Token** | https://t.me/BotFather |
| **OpenAI API** | https://platform.openai.com/api-keys |
| **OpenWeather** | https://openweathermap.org/api |
| **Yandex Maps** | https://developer.tech.yandex.ru/ |
| **Tavily** | https://tavily.com/ |



---

## 📊 Метрики качества

RAG:
📊 MRR (Mean Reciprocal Rank): 0.6862

📈 Recall@K:
   Recall@1: 0.5978
   Recall@3: 0.7609
   Recall@5: 0.8043
   Recall@10: 0.8804

🎯 Precision@K:
   Precision@1: 0.5978
   Precision@3: 0.2536
   Precision@5: 0.1609
   Precision@10: 0.0880

📉 NDCG@K:
   NDCG@1: 0.5978
   NDCG@3: 0.7688
   NDCG@5: 0.7917
   NDCG@10: 0.8163

✅ Hit Rate@K:
   Hit@1: 0.5978
   Hit@3: 0.7609
   Hit@5: 0.8043
   Hit@10: 0.8804

---
**Whole system:**
LLM as a Judge 
Критерии оценки (саммари):

**Агент релевантности**
Оценивает, насколько ответ соответствует запросу пользователя: правильно ли понята цель, учтены ли предпочтения и ограничения, и покрывает ли маршрут все ключевые части сценария (например “выставка → поесть”).

**Агент практичности**
Проверяет выполнимость маршрута: логичность последовательности, реалистичный тайминг, наличие времени на переезды/очереди, отсутствие конфликтов по времени работы и расстояниям.

**Агент качества изложения**
Оценивает, насколько маршрут понятен и удобен для пользователя: структурированность, читаемость, полезные детали (время, адреса/районы, стоимость/бюджет, как добраться), наличие чётких шагов. 

---
📊 РЕЗУЛЬТАТЫ ОЦЕНКИ СИСТЕМЫ JOURNEY AGENT
---

🎯 ОБЩИЙ БАЛЛ: 7.52/10

---
📈 ОЦЕНКИ ПО АГЕНТАМ:
---

  Агент релевантности:
    Среднее: 7.35/10
    Мин/Макс: 4.5/9.5
    Стд. откл.: 1.31

  Агент практичности:
    Среднее: 7.68/10
    Мин/Макс: 1.5/8.5
    Стд. откл.: 2.05

  Агент качества изложения:
    Среднее: 7.55/10
    Мин/Макс: 3.5/8.5
    Стд. откл.: 1.39

---
📋 ОЦЕНКИ ПО КРИТЕРИЯМ:

  Агент качества изложения_Ясность изложения: 5.75/10 (мин: 3.0, макс: 8.0)
  Агент качества изложения_Полезность деталей: 6.25/10 (мин: 4.0, макс: 9.0)


---
**Event extractor metrics**
By LLM as a Judge 
Критерии:
**Агент точности** извлечения оценивает, насколько корректно и полно из текста извлечены данные о событии (заголовок, описание, дата, место), поощряя корректное отсутствие события и наказывая пропуск реального события.

**Агент качества** данных проверяет информативность и краткость заголовка, а также полезность и чистоту описания, выставляя нейтральную оценку, если события не было.

**Агент категоризации** оценивает правильность тегов и релевантность, определяя, является ли сообщение реальным событием и корректно ли оно классифицировано.

ОБЩИЙ БАЛЛ: 8.78/10
   Процент извлечения: 100.0%

---
📈 ОЦЕНКИ ПО АГЕНТАМ:
---

  Агент точности извлечения:
    Среднее: 8.57/10
    Мин/Макс: 6.5/10.0
    Стд. откл.: 1.16

  Агент качества данных:
    Среднее: 8.23/10
    Мин/Макс: 7.5/8.5
    Стд. откл.: 0.46

  Агент категоризации:
    Среднее: 9.53/10
    Мин/Макс: 9.0/10.0
    Стд. откл.: 0.52

---
📋 ОЦЕНКИ ПО КРИТЕРИЯМ:
---
  Агент качества данных_Качество заголовка: 9.0/10 (мин: 9.0, макс: 9.0)
  Агент качества данных_Качество описания: 8.0/10 (мин: 8.0, макс: 8.0)
  Агент категоризации_Правильность категоризации: 9.83/10 (мин: 9.0, макс: 10.0)
  Агент категоризации_Релевантность: 9.83/10 (мин: 9.0, макс: 10.0)

---

## 📝 Данные

### Источники данных

| Источник | Объём | Статус |
|----------|-------|--------|
| KudaGo (Москва, СПб) | ~1000 событий | ✅ Загружено |
| Telegram каналы | 27+ событий | ✅ Тестовые данные |

### Формат события

```json
{
  "title": "Название события",
  "description": "Описание",
  "location": "Адрес/место",
  "date": "2025-12-28",
  "tags": ["концерт", "музыка"],
  "url": "https://...",
  "source": "kudago",
  "owner": null
}
```


