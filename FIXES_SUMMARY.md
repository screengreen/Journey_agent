# Исправления проблем с количеством мероприятий и временем

## Дата: 2026-01-26

## Проблемы

### 1. Много мероприятий даже при запросе "немного"
**Корень проблемы:**
- Отсутствовало поле `max_events` в модели `Constraints`
- LLM планировщик не получал инструкции ограничивать количество событий по запросу пользователя
- Отсутствовала валидация количества событий в плане

### 2. Время всегда рандомное
**Корень проблемы:**
- Некорректный парсинг времени в `extract_constraints_node` (строка "HH:MM" не конвертировалась в объект `time`)
- Недостаточно строгие инструкции в промптах планировщика по соблюдению временных рамок
- Отсутствовала валидация временных ограничений

## Внесенные исправления

### 1. Модель Constraints (`src/planner_agent/models.py`)
**Добавлено новое поле:**
```python
max_events: Optional[int] = Field(description="Максимальное количество событий в плане", default=None)
```

### 2. Извлечение constraints (`src/vdb/rag/self_rag_graph.py`)

#### Обновлен промпт CONSTRAINTS_EXTRACTION_PROMPT:
- Добавлено поле `max_events` в JSON схему
- Добавлены правила извлечения количества событий:
  - "пару" = 2
  - "несколько" = 3
  - "немного" = 3-4
- Улучшены инструкции по извлечению времени (строгий формат "HH:MM")

#### Улучшена функция `extract_constraints_node`:
- Добавлена конвертация строкового времени в объекты `time`:
  ```python
  hours, minutes = data["start_time"].split(":")
  data["start_time"] = time_type(int(hours), int(minutes))
  ```
- Добавлено логирование извлеченных constraints
- Улучшена обработка ошибок

### 3. Промпты планировщика (`src/planner_agent/agents.py`)

#### Обновлен `create_reasoning` system_prompt:
- Добавлен раздел "КРИТИЧЕСКИ ВАЖНО - соблюдай ограничения пользователя"
- Явные инструкции по соблюдению `max_events` и временных рамок

#### Обновлен `create_plan` system_prompt:
- Добавлен раздел "КРИТИЧЕСКИ ВАЖНО - СТРОГО соблюдай ограничения"
- Пункт 1: строгое соблюдение `max_events`
- Пункт 2: строгое соблюдение временных рамок

#### Обновлен `create_plan` user_prompt:
- Добавлен раздел "ВАЖНО ПО КОЛИЧЕСТВУ СОБЫТИЙ" с явными инструкциями
- Добавлен раздел "ВАЖНО ПО ВРЕМЕНИ" с явными инструкциями
- Подчеркивается необходимость НЕ ПРЕВЫШАТЬ лимиты

#### Обновлен constraints_str (все места):
- Добавлено отображение `max_events` в строке ограничений

### 4. Валидация плана (`src/planner_agent/agents.py`)

#### Добавлена валидация после создания плана в `create_plan`:
```python
validation_warnings = []

# Проверка количества событий
if constraints.max_events and len(plan.items) > constraints.max_events:
    validation_warnings.append(...)

# Проверка временных рамок
if constraints.start_time and plan.items:
    first_start = plan.items[0].start_time
    if first_start < constraints.start_time:
        validation_warnings.append(...)

if constraints.end_time and plan.items:
    last_end = plan.items[-1].end_time
    if last_end > constraints.end_time:
        validation_warnings.append(...)
```

### 5. Промпт критика (`src/planner_agent/agents.py`)

#### Обновлен `critique_plan` user_prompt:
- Добавлен раздел "КРИТИЧЕСКИ ВАЖНО - проверь соблюдение ограничений"
- Проверка количества событий - критерий #1
- Проверка временных рамок - критерий #2
- Явно указано: нарушение этих ограничений = КРИТИЧЕСКАЯ ПРОБЛЕМА

## Тестирование

Создан тестовый скрипт `test_fixes.py` для проверки исправлений:

### Тест 1: Проверка max_events
- Запрос: "Хочу посетить 2 места в Москве, время с 10 до 14 часов"
- Проверяет:
  - Извлечение `max_events = 2`
  - План содержит не более 2 событий
  - Временные рамки соблюдены

### Тест 2: Проверка временных ограничений
- Запрос: "Хочу посетить немного мест в Санкт-Петербурге, время с 12:00 до 15:00"
- Проверяет:
  - Извлечение `start_time = 12:00`, `end_time = 15:00`
  - Извлечение `max_events` (примерно 3-4)

### Запуск тестов:
```bash
python test_fixes.py
```

## Ожидаемые результаты

После внесения исправлений:

1. **Количество мероприятий:**
   - ✅ Система корректно извлекает количество событий из запроса пользователя
   - ✅ LLM планировщик строго соблюдает ограничение `max_events`
   - ✅ Критик проверяет соблюдение этого ограничения
   - ✅ Валидация предупреждает о превышении лимита

2. **Временные ограничения:**
   - ✅ Система корректно извлекает время начала/окончания
   - ✅ LLM планировщик строго соблюдает временные рамки
   - ✅ Критик проверяет соблюдение временных рамок
   - ✅ Валидация предупреждает о нарушении временных рамок

## Файлы с изменениями

1. `src/planner_agent/models.py` - добавлено поле `max_events`
2. `src/vdb/rag/self_rag_graph.py` - улучшен промпт и функция извлечения constraints
3. `src/planner_agent/agents.py` - обновлены промпты и добавлена валидация
4. `test_fixes.py` - новый файл с тестами

## Примеры использования

### Пример 1: Ограничение количества
```
Пользователь: "Хочу посетить 2 музея в Москве"
Результат: План содержит ровно 2 музея (не больше!)
```

### Пример 2: Временные рамки
```
Пользователь: "Хочу погулять с 10 до 14 часов в СПБ"
Результат: Все события в плане начинаются после 10:00 и заканчиваются до 14:00
```

### Пример 3: Комбинация
```
Пользователь: "Хочу посетить пару мест в Москве, время с 12 до 16 часов"
Результат: 
- max_events = 2
- start_time = 12:00
- end_time = 16:00
- План содержит 2 события в диапазоне 12:00-16:00
```

## Дополнительные улучшения

Для дальнейшего улучшения можно:

1. Добавить тесты на реальных данных
2. Добавить метрики качества извлечения constraints
3. Добавить A/B тестирование для оценки улучшений
4. Расширить валидацию (проверка бюджета, транспорта и т.д.)
5. Добавить фидбек от пользователей о качестве планов
